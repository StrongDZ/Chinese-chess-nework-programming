@startuml
title Sign Out Sequence Diagram - Chinese Chess (TCP Socket)

skinparam sequenceMessageAlign center
skinparam responseMessageBelowArrow true

actor User
participant "Client" as Client
participant "TCP Socket" as Socket
participant "Server" as Server
database "Database" as DB

== Sign Out Request ==
User -> Client: Click "Sign Out" button
activate Client

Client -> Client: Show confirmation dialog
Client -> User: "Are you sure you want to sign out?"

alt User cancels
    User -> Client: Click "Cancel"
    Client -> User: Stay in current page
    deactivate Client
    
else User confirms
    User -> Client: Click "Confirm"
    
    == Check Active Game ==
    alt User is in active game
        Client -> Client: Detect active game session
        Client -> Client: Create SaveGamePacket:\n{type="SAVE_GAME", gameID, moves[]}
        
        Client -> Socket: send(SaveGamePacket)
        activate Socket
        Socket -> Server: Forward packet
        deactivate Socket
        
        Server -> Server: Parse save game request
        Server -> DB: INSERT INTO game_history\n(gameID, moves, status='INTERRUPTED')
        activate DB
        DB --> Server: Game saved
        deactivate DB
        
        Server -> Socket: send(ACK_SAVED)
        activate Socket
        Socket -> Client: Game saved confirmation
        deactivate Socket
    end
    
    == Send Sign Out Request ==
    Client -> Client: Create SignOutPacket:\n{type="SIGNOUT", sessionID, userID}
    
    Client -> Socket: send(SignOutPacket)
    activate Socket
    Socket -> Server: Forward packet
    deactivate Socket
    
    Server -> Server: Parse sign out request
    Server -> Server: Validate sessionID
    
    alt Invalid session
        Server -> Socket: send(ERROR_INVALID_SESSION)
        activate Socket
        Socket -> Client: Forward error
        deactivate Socket
        Client -> User: Show "Session expired"
        
    else Valid session
        == Update User Status ==
        Server -> DB: UPDATE users SET\nstatus='OFFLINE',\nlast_logout=NOW()\nWHERE userID=?
        activate DB
        DB --> Server: Status updated
        deactivate DB
        
        == Remove from Online Players ==
        Server -> Server: Remove from activeUsers list:\nactiveUsers.remove(userID)
        
        Server -> Server: Broadcast to other clients:\nLOBBY_UPDATE (player offline)
        
        == Clear Session ==
        Server -> Server: Delete session:\nsessions.remove(sessionID)
        
        Server -> Server: Create ResponsePacket:\n{status="SUCCESS",\nmsg="Signed out successfully"}
        
        Server -> Socket: send(ResponsePacket)
        activate Socket
        Socket -> Client: Forward response
        deactivate Socket
        
        == Client Cleanup ==
        Client -> Client: Clear local session data:\ndelete sessionID,\ndelete userInfo
        
        Client -> Client: Close game UI
        Client -> User: Show "Signed out successfully"
        
        == Close TCP Connection ==
        Client -> Socket: send(CLOSE_CONNECTION)
        activate Socket
        Socket -> Server: Forward close request
        deactivate Socket
        
        Server -> Server: Log: "Client disconnected"
        Server -> Socket: close(clientSocket)
        activate Socket
        Socket -> Client: Connection closed
        deactivate Socket
        
        Client -> Client: close(socket)
        
        Client -> User: Redirect to Login page
        deactivate Client
        
        Server -> Server: Free resources:\ndelete thread/handler
        deactivate Server
    end
end

@enduml