@startuml
' Finite State Machine - Chinese Chess Client Session (Hierarchical)

left to right direction

skinparam BackgroundColor #0B1418
skinparam FontColor #E8F1F5
skinparam shadowing false
skinparam linetype ortho
skinparam DefaultTextAlignment center
skinparam ArrowColor #6EC1E4
skinparam state {
  BackgroundColor #0E1E25
  BorderColor #6EC1E4
  FontColor #E8F1F5
  RoundCorner 12
}

[*] --> Disconnected

state Disconnected
state Connecting
state Connected
state SigningIn
state Authenticated
state Lobby
state Reconnecting
state GameOver

' Nested states with themed colors
state SearchingGame #102535 {
  state Matchmaking
  state Challenging
}

state Playing #10201A {
  state InGame
  state InGameAI
}

' Connection lifecycle
Disconnected --> Connecting : connect() / [open_socket]
Connecting --> Connected : CONNECT_OK [socket_ok] / [set_channel]
Connecting --> Disconnected : CONNECT_FAIL | TIMEOUT / [close_socket]

' Authentication
Connected --> SigningIn : LOGIN{user,pass} / [send_login]
SigningIn --> Authenticated : LOGIN_OK [cred_valid] / [set_session]
SigningIn --> Connected : LOGIN_FAIL / [show_error]

' Session exit (global)
Authenticated --> Disconnected : SIGNOUT / [clear_session, close_socket]
Lobby --> Disconnected : SIGNOUT / [clear_session, close_socket]
Playing --> Disconnected : SIGNOUT / [save_if_needed]
GameOver --> Disconnected : SIGNOUT
SearchingGame --> Disconnected : SIGNOUT

' Lobby data
Authenticated --> Lobby : REQUEST_LOBBY / [send_req] \n LOBBY_DATA / [render_lobby]

' Search game (hierarchical)
Lobby --> SearchingGame : MATCH_REQUEST [timeMode_ok] / [enqueue]

' Inside SearchingGame
Lobby --> Matchmaking : MATCH_REQUEST(timeMode)
Lobby --> Challenging : CHALLENGE_SENT(target)
Matchmaking --> InGame : MATCH_FOUND / [create_room, start_game]
Matchmaking --> Lobby : CANCEL
Matchmaking --> Lobby : MATCH_TIMEOUT / [dequeue]
Challenging --> InGame : CHALLENGE_ACCEPT [target_online] / [create_room, start_game]
Challenging --> Lobby : CHALLENGE_DECLINE | CANCEL | TIMEOUT / [notify_user]

' AI game path
Lobby --> InGameAI : START_GAME_AI(difficulty) / [init_ai(difficulty)]

' Reconnect flow
Authenticated --> Reconnecting : SOCKET_CLOSED | HEARTBEAT_TIMEOUT / [start_reconnect]
Lobby --> Reconnecting : SOCKET_CLOSED | HEARTBEAT_TIMEOUT / [start_reconnect]
SearchingGame --> Reconnecting : SOCKET_CLOSED | HEARTBEAT_TIMEOUT / [recover_queue]
Playing --> Reconnecting : SOCKET_CLOSED | HEARTBEAT_TIMEOUT / [pause_timers]
GameOver --> Reconnecting : SOCKET_CLOSED | HEARTBEAT_TIMEOUT
Reconnecting --> InGame : REJOIN_OK [room_found] / [sync_state]
Reconnecting --> InGameAI : REJOIN_OK [ai_game] / [sync_state]
Reconnecting --> Disconnected : REJOIN_FAIL / [go_offline]

' In-game lifecycle (inside Playing)
InGame --> GameOver : GAME_RESULT(reason) / [persist_history, update_elo]
InGameAI --> GameOver : GAME_RESULT(reason) / [persist_history]

' Rematch / Replay / Return
GameOver --> Lobby : RETURN
GameOver --> InGame : REMATCH_ACCEPT / [reuse_room]
GameOver --> Lobby : VIEW_REPLAY (exit replay)

legend right
  <b>Legend</b>
  Colors:
  - SearchingGame = #102535
  - Playing = #10201A
  - Arrows = #6EC1E4
  Notation: Trigger [Guard] / [Effect]
endlegend

@enduml
