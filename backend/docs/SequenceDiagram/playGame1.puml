@startuml
title Play Game (Main) - Sequence Diagram (TCP Socket)

skinparam sequenceMessageAlign center
skinparam responseMessageBelowArrow true

actor User
boundary "UI" as UI
control "TCP Socket" as Socket
control "Server" as Server
database "Database" as DB


== Game Play (Common for all types) ==

activate UI
activate Server

loop Until game ends (Win/Loss/Draw/Resign)
    alt Player's Turn
        User -> UI: Make move (fromâ†’to)
        
        UI -> UI: Validate move locally
        
        alt Invalid move
            UI -> User: Show "Invalid move"
            
        else Valid move
            UI -> Socket: send(MOVE)
            activate Socket
            Socket -> Server: Forward move
            deactivate Socket
            
            Server -> Server: Validate move on server
            Server -> Server: Update board state
            Server -> Server: Check game rules
            
            Server -> DB: Save move
            activate DB
            DB --> Server: Move saved
            deactivate DB
            
            alt Game ended
                Server -> DB: End game
                activate DB
                DB --> Server: Game ended
                deactivate DB
                
                Server -> DB: Update player stats
                activate DB
                DB --> Server: Stats updated
                deactivate DB
                
                Server -> Socket: send(GAME_END)
                activate Socket
                Socket -> UI: Forward result
                deactivate Socket
                
                UI -> User: Display game result
                
            else Game continues
                Server -> Socket: send(INFO)
                activate Socket
                Socket -> UI: Confirmation
                deactivate Socket
                
                Server -> Socket: send(MOVE)
                activate Socket
                Socket --> UI: Update opponent's board
                deactivate Socket
                
                UI -> UI: Update board display
                UI -> User: Show move animation\nWait for opponent
            end
        end
        
    else Special Actions
        alt Resign
            User -> UI: Click "Resign"
            UI -> Socket: send(RESIGN)
            activate Socket
            Socket -> Server: Forward resign
            deactivate Socket
            
            Server -> DB: End game
            activate DB
            DB --> Server: Updated
            deactivate DB
            
            Server -> Socket: send(GAME_END)
            activate Socket
            Socket -> UI: Forward result
            deactivate Socket
            
            UI -> User: Show "You resigned"
            
        else Offer Draw
            User -> UI: Click "Offer Draw"
            UI -> Socket: send(DRAW_REQUEST)
            activate Socket
            Socket -> Server: Forward offer
            deactivate Socket
            
            Server -> Socket: send(DRAW_REQUEST)
            activate Socket
            Socket --> UI: Opponent receives offer
            deactivate Socket
            
            note right
              Wait for opponent response
              Accept/Decline draw
            end note
            
        else Request Rematch
            User -> UI: Click "Rematch" (after game ends)
            
            note right
              Similar to Challenge flow
              Send rematch request
              Wait for acceptance
            end note
        end
    end
end

deactivate UI
deactivate Server


@enduml