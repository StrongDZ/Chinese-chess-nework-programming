\subsection{Player Challenge Flow}

This sequence diagram illustrates the complete player-to-player challenge process, from challenge request initiation to game start. The challenge flow involves two players, with the challenger sending a request and the target player responding with either acceptance or decline.

\textbf{Challenge Request:} When Player 1 clicks the challenge button, \texttt{PlayWithFriendPanel} retrieves the game mode and time limit from \texttt{UIState}, then routes the request through \texttt{NetworkManager} and \texttt{GameSender} to \texttt{SocketClient} for transmission. The server's \texttt{handleChallenge()} validates that both players are logged in and checks the target's availability using the in-memory \texttt{g\_username\_to\_fd} map. If the target is online, the server stores pending challenge information (mode, time limit, challenger username) in the target player's \texttt{PlayerInfo} structure and forwards the \texttt{CHALLENGE\_REQUEST} to Player 2. The challenger receives an \texttt{INFO} message confirming the challenge was sent and displays a waiting panel.

\textbf{Challenge Response:} Player 2 receives the challenge request through \texttt{GameHandler}, which displays a challenge dialog showing the challenger's username, game mode, and time limit. If Player 2 declines, the server forwards the \texttt{CHALLENGE\_RESPONSE} to the challenger and sends an \texttt{INFO} message to the responder. If Player 2 accepts, the server calls \texttt{handleStartGame()}, which creates the game in the database through the \texttt{GameController} → \texttt{GameService} → \texttt{GameRepository} chain. The service randomly assigns red and black sides (red goes first in Xiangqi), creates the game document with initial XFEN, and returns the game ID. The server then sets up game state for both players (in-game status, opponent file descriptor, game ID, color assignment, current turn) and sends \texttt{GAME\_START} messages to both clients with opponent information, game mode, time limit, and color assignment.

\textbf{Challenge Storage:} Challenge information is stored only in memory within the target player's \texttt{PlayerInfo} structure (pending\_challenge\_mode, pending\_challenge\_time, pending\_challenger). No challenge data is persisted to the database until the challenge is accepted and a game is created.


